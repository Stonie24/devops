- name: Generate dynamic hosts file from Azure tags
  hosts: localhost
  gather_facts: false
  tasks:

    - name: Get facts by tags
      azure_rm_virtualmachine_info:
        resource_group: "{{ resource_group }}"
        tags:
          StudentId: "{{ vmtags.StudentId }}"
      register: az_facts

    - name: Build hosts file content
      set_fact:
        hosts_content: |
          [local]
          localhost ansible_connection=local

          [app_servers]
          {% for vm in az_facts.vms | selectattr('tags.Type', 'equalto', 'appserver') %}
          {{ vm.name }} ansible_host={{ vm.tags.PublicIP }} ansible_user=azureuser
          {% endfor %}

          [db_servers]
          {% for vm in az_facts.vms | selectattr('tags.Type', 'equalto', 'database') %}
          {{ vm.name }} ansible_host={{ vm.tags.PublicIP }} ansible_user=azureuser
          {% endfor %}

          [load_balancers]
          {% for vm in az_facts.vms | selectattr('tags.Type', 'equalto', 'loadbalancer') %}
          {{ vm.name }} ansible_host={{ vm.tags.PublicIP }} ansible_user=azureuser
          {% endfor %}

          [devops:children]
          app_servers
          db_servers
          load_balancers

    - name: Write hosts file
      copy:
        content: "{{ hosts_content }}"
        dest: "{{ playbook_dir }}/hosts"
        backup: yes
      delegate_to: localhost
